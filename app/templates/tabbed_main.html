<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Royal Road - Books Explorer</title>
	<!-- Include HTMX from CDN -->
	<script src="https://unpkg.com/htmx.org@1.9.6" integrity="sha384-FhXw7b6AlE/jyjlZH5iHa/tTe9EpJ1Y55RjcgPbjeWMskSxZt1v9qkxLJWNJaGni" crossorigin="anonymous"></script>
	<style>
		:root {
			/* Light theme variables */
			--bg-primary: #f5f5f5;
			--bg-secondary: white;
			--text-primary: #333;
			--text-secondary: #7f8c8d;
			--accent-color: #3498db;
			--accent-hover: #2980b9;
			--border-color: #ddd;
			--shadow: rgba(0,0,0,0.1);
			--shadow-hover: rgba(0,0,0,0.1);
			--tab-inactive: #e9ecef;
			--tab-active: white;
			--success-color: #28a745;
			--error-color: #dc3545;
			--warning-color: #ffc107;
		}

		[data-theme="dark"] {
			/* Dark theme variables */
			--bg-primary: #1a1a1a;
			--bg-secondary: #2d2d2d;
			--text-primary: #e0e0e0;
			--text-secondary: #a0a0a0;
			--accent-color: #4a9eff;
			--accent-hover: #357abd;
			--border-color: #444;
			--shadow: rgba(0,0,0,0.3);
			--shadow-hover: rgba(0,0,0,0.4);
			--tab-inactive: #3a3a3a;
			--tab-active: #2d2d2d;
			--success-color: #28a745;
			--error-color: #dc3545;
			--warning-color: #ffc107;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			line-height: 1.6;
			color: var(--text-primary);
			max-width: 1000px;
			margin: 0 auto;
			padding: 20px;
			background-color: var(--bg-primary);
			transition: background-color 0.3s ease, color 0.3s ease;
		}

		h1 {
			color: var(--text-primary);
			text-align: center;
			margin-bottom: 30px;
			border-bottom: 2px solid var(--accent-color);
			padding-bottom: 10px;
		}

		.header-controls {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 20px;
			margin-bottom: 20px;
		}

		.theme-toggle {
			background: var(--bg-secondary);
			border: 1px solid var(--border-color);
			color: var(--text-primary);
			padding: 8px 15px;
			border-radius: 4px;
			cursor: pointer;
			transition: all 0.2s;
		}

		.theme-toggle:hover {
			background-color: var(--accent-color);
			color: white;
		}

		/* Tab styling */
		.tabs {
			background-color: var(--bg-secondary);
			border-radius: 8px;
			box-shadow: 0 2px 10px var(--shadow);
			overflow: hidden;
		}

		.tab-buttons {
			display: flex;
			background-color: var(--tab-inactive);
			border-bottom: 1px solid var(--border-color);
		}

		.tab-btn {
			flex: 1;
			padding: 15px 20px;
			background: none;
			border: none;
			cursor: pointer;
			color: var(--text-primary);
			font-size: 16px;
			font-weight: 500;
			transition: all 0.2s;
			border-right: 1px solid var(--border-color);
		}

		.tab-btn:last-child {
			border-right: none;
		}

		.tab-btn.active {
			background-color: var(--tab-active);
			color: var(--accent-color);
			font-weight: 600;
		}

		.tab-btn:hover:not(.active) {
			background-color: var(--bg-primary);
		}

		.tab-content {
			min-height: 400px;
			background-color: var(--tab-active);
		}

		.tab-pane {
			display: none;
			padding: 20px;
		}

		.tab-pane.active {
			display: block;
		}

		/* Search interface styling */
		.search-container {
			margin-bottom: 20px;
		}

		.search-input-group {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
		}

		#searchQuery {
			flex: 1;
			padding: 12px 15px;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			font-size: 16px;
			background-color: var(--bg-secondary);
			color: var(--text-primary);
			transition: all 0.2s;
		}

		#searchQuery:focus {
			outline: none;
			border-color: var(--accent-color);
		}

		.search-btn {
			background-color: var(--accent-color);
			color: white;
			border: none;
			padding: 12px 20px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			transition: background-color 0.2s;
		}

		.search-btn:hover {
			background-color: var(--accent-hover);
		}

		/* Popular books interface styling */
		.popular-search-container {
			margin-bottom: 20px;
			text-align: center;
		}

		#popularSearchInput {
			padding: 8px 15px;
			width: 70%;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			font-size: 16px;
			background-color: var(--bg-secondary);
			color: var(--text-primary);
			transition: all 0.2s;
		}

		#popularSearchInput:focus {
			outline: none;
			border-color: var(--accent-color);
		}

		/* Book list styling */
		.book-list {
			list-style-type: none;
			padding: 0;
		}

		.book-item {
			background-color: var(--bg-secondary);
			margin-bottom: 10px;
			padding: 15px;
			border-radius: 5px;
			box-shadow: 0 2px 5px var(--shadow);
			transition: transform 0.2s, box-shadow 0.2s;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.book-item:hover {
			transform: translateY(-3px);
			box-shadow: 0 5px 15px var(--shadow-hover);
		}

		.book-info {
			flex: 1;
		}

		.book-item a {
			color: var(--accent-color);
			text-decoration: none;
			font-weight: bold;
			font-size: 18px;
		}

		.book-item a:hover {
			text-decoration: underline;
		}

		.book-actions {
			display: flex;
			gap: 10px;
		}

		.memorize-btn, .remove-btn {
			padding: 6px 12px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.2s;
		}

		.memorize-btn {
			background-color: var(--success-color);
			color: white;
		}

		.memorize-btn:hover {
			background-color: #218838;
		}

		.remove-btn {
			background-color: var(--error-color);
			color: white;
		}

		.remove-btn:hover {
			background-color: #c82333;
		}

		.no-results {
			text-align: center;
			font-style: italic;
			color: var(--text-secondary);
			padding: 20px;
		}

		.refresh-btn {
			background-color: var(--accent-color);
			color: white;
			border: none;
			padding: 8px 15px;
			border-radius: 4px;
			cursor: pointer;
			margin-top: 10px;
			transition: background-color 0.2s;
		}

		.refresh-btn:hover {
			background-color: var(--accent-hover);
		}

		.memorized-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
		}

		.memorized-count {
			color: var(--text-secondary);
			font-size: 14px;
		}

		footer {
			margin-top: 30px;
			text-align: center;
			font-size: 14px;
			color: var(--text-secondary);
		}

		.htmx-indicator {
			opacity: 0;
			transition: opacity 200ms ease-in;
			color: var(--accent-color);
		}

		.htmx-request .htmx-indicator {
			opacity: 1;
		}

		.htmx-request.htmx-indicator {
			opacity: 1;
		}

		.status-message {
			padding: 10px;
			border-radius: 4px;
			margin-bottom: 15px;
			font-weight: 500;
		}

		.status-success {
			background-color: rgba(40, 167, 69, 0.1);
			color: var(--success-color);
			border: 1px solid var(--success-color);
		}

		.status-error {
			background-color: rgba(220, 53, 69, 0.1);
			color: var(--error-color);
			border: 1px solid var(--error-color);
		}

		@media (max-width: 600px) {
			.header-controls {
				flex-direction: column;
				gap: 10px;
			}

			#popularSearchInput {
				width: 90%;
			}

			.search-input-group {
				flex-direction: column;
			}

			.book-item {
				flex-direction: column;
				align-items: stretch;
				gap: 10px;
			}

			.book-actions {
				justify-content: center;
			}

			.tab-btn {
				font-size: 14px;
				padding: 12px 15px;
			}
		}
	</style>
</head>
<body data-theme="light">
	<h1>Royal Road Books Explorer</h1>

	<div class="header-controls">
		<button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
	</div>

	<div class="tabs">
		<div class="tab-buttons">
			<button class="tab-btn active" data-tab="popular">Popular Books</button>
			<button class="tab-btn" data-tab="search">Search & Memorize</button>
		</div>
		
		<div class="tab-content">
			<!-- Popular Books Tab -->
			<div id="popular-tab" class="tab-pane active">
				<div class="popular-search-container">
					<input type="text" name="search" id="popularSearchInput" placeholder="Filter popular books..." 
						hx-post="/search"
						hx-trigger="input changed delay:500ms, search"
						hx-target="#popular-book-results"
						hx-indicator="#popular-search-indicator">
					<span id="popular-search-indicator" class="htmx-indicator">Searching...</span>
				</div>

				<div id="popular-book-results">
					<ul class="book-list">
						{{if .}}
							{{range .}}
							<li class="book-item">
								<div class="book-info">
									<a href="{{.Link}}" target="_blank">{{.Title}}</a>
								</div>
								<div class="book-actions">
									<button class="memorize-btn"
										hx-post="/memorize-book"
										hx-vals='{"title": "{{.Title}}", "link": "{{.Link}}"}'
										hx-target="#memorize-status"
										hx-indicator="#memorize-indicator">
										üìö Memorize
									</button>
								</div>
							</li>
							{{end}}
						{{else}}
							<div class="no-results">
								No books found matching your search.
							</div>
						{{end}}
					</ul>
				</div>

				<div style="text-align: center;">
					<button class="refresh-btn"
						hx-get="/refresh"
						hx-target="#popular-book-results"
						hx-indicator="#refresh-indicator">
						Refresh Books
					</button>
					<span id="refresh-indicator" class="htmx-indicator">Loading...</span>
				</div>

				<div id="memorize-status"></div>
				<span id="memorize-indicator" class="htmx-indicator">Memorizing...</span>
			</div>

			<!-- Search & Memorize Tab -->
			<div id="search-tab" class="tab-pane">
				<div class="search-container">
					<div class="search-input-group">
						<input type="text" id="searchQuery" name="query" placeholder="Search Royal Road books..." required>
						<button class="search-btn"
							hx-post="/search-books"
							hx-include="#searchQuery"
							hx-target="#search-results"
							hx-indicator="#search-indicator">
							üîç Search
						</button>
					</div>
					<span id="search-indicator" class="htmx-indicator">Searching Royal Road...</span>
				</div>

				<div id="search-results">
					<div class="no-results">
						Enter a search term above to find books on Royal Road.
					</div>
				</div>

				<div class="memorized-header">
					<h3>üìö Memorized Books</h3>
					<button class="refresh-btn"
						hx-get="/memorized-books"
						hx-target="#memorized-results"
						hx-indicator="#memorized-indicator">
						Refresh List
					</button>
				</div>
				<span id="memorized-indicator" class="htmx-indicator">Loading...</span>

				<div id="memorized-results">
					<!-- Memorized books will be loaded here -->
				</div>
			</div>
		</div>
	</div>

	<footer>
		Data scraped from Royal Road's Active Popular Fiction List
	</footer>

	<script>
		// Global variables for debouncing and state management
		let searchTimeout = null;
		let lastSearchQuery = '';
		let isSearching = false;

		// Main initialization
		document.addEventListener('DOMContentLoaded', function() {
			initializeTheme();
			initializeTabs();
			initializeSearch();
			initializeHTMXEventHandlers();
			loadMemorizedBooks();
		});

		// Theme management
		function initializeTheme() {
			const savedTheme = localStorage.getItem('theme') || 'light';
			const body = document.body;
			const themeToggle = document.querySelector('.theme-toggle');
			
			body.setAttribute('data-theme', savedTheme);
			updateThemeToggleText(savedTheme, themeToggle);
		}

		function updateThemeToggleText(theme, toggle) {
			if (theme === 'dark') {
				toggle.textContent = '‚òÄÔ∏è Light Mode';
			} else {
				toggle.textContent = 'üåô Dark Mode';
			}
		}

		function toggleTheme() {
			const body = document.body;
			const themeToggle = document.querySelector('.theme-toggle');
			const currentTheme = body.getAttribute('data-theme');
			
			if (currentTheme === 'light') {
				body.setAttribute('data-theme', 'dark');
				localStorage.setItem('theme', 'dark');
				updateThemeToggleText('dark', themeToggle);
			} else {
				body.setAttribute('data-theme', 'light');
				localStorage.setItem('theme', 'light');
				updateThemeToggleText('light', themeToggle);
			}
		}

		// Tab management
		function initializeTabs() {
			const tabButtons = document.querySelectorAll('.tab-btn');
			const tabPanes = document.querySelectorAll('.tab-pane');

			tabButtons.forEach(button => {
				button.addEventListener('click', function() {
					const targetTab = this.getAttribute('data-tab');
					switchTab(targetTab, tabButtons, tabPanes);
				});
			});

			// Keyboard navigation for tabs
			tabButtons.forEach((button, index) => {
				button.addEventListener('keydown', function(e) {
					if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
						e.preventDefault();
						const nextIndex = e.key === 'ArrowRight' 
							? (index + 1) % tabButtons.length 
							: (index - 1 + tabButtons.length) % tabButtons.length;
						
						tabButtons[nextIndex].focus();
						tabButtons[nextIndex].click();
					}
				});
			});
		}

		function switchTab(targetTab, tabButtons, tabPanes) {
			// Remove active class from all buttons and panes
			tabButtons.forEach(btn => btn.classList.remove('active'));
			tabPanes.forEach(pane => pane.classList.remove('active'));

			// Add active class to target button and pane
			const targetButton = document.querySelector(`[data-tab="${targetTab}"]`);
			const targetPane = document.getElementById(targetTab + '-tab');
			
			if (targetButton && targetPane) {
				targetButton.classList.add('active');
				targetPane.classList.add('active');
				
				// Focus management for accessibility
				targetButton.setAttribute('aria-selected', 'true');
				tabButtons.forEach(btn => {
					if (btn !== targetButton) {
						btn.setAttribute('aria-selected', 'false');
					}
				});
			}

			// Load memorized books when switching to search tab
			if (targetTab === 'search') {
				loadMemorizedBooks();
			}

			// Clear search results when switching away from search tab
			if (targetTab === 'popular') {
				clearSearchStatus();
			}
		}

		// Search functionality with debouncing
		function initializeSearch() {
			const searchInput = document.getElementById('searchQuery');
			if (searchInput) {
				// Enhanced search with debouncing
				searchInput.addEventListener('input', function(e) {
					handleSearchInput(e.target.value);
				});

				// Handle Enter key for immediate search
				searchInput.addEventListener('keydown', function(e) {
					if (e.key === 'Enter') {
						e.preventDefault();
						performImmediateSearch(e.target.value);
					}
				});

				// Clear search on Escape
				searchInput.addEventListener('keydown', function(e) {
					if (e.key === 'Escape') {
						clearSearch();
					}
				});
			}
		}

		function handleSearchInput(query) {
			const trimmedQuery = query.trim();
			
			// Clear previous timeout
			if (searchTimeout) {
				clearTimeout(searchTimeout);
			}

			// Don't search if query is too short or same as last search
			if (trimmedQuery.length < 2) {
				clearSearchResults();
				return;
			}

			if (trimmedQuery === lastSearchQuery) {
				return;
			}

			// Debounced search
			searchTimeout = setTimeout(() => {
				performSearch(trimmedQuery);
			}, 500);
		}

		function performImmediateSearch(query) {
			const trimmedQuery = query.trim();
			
			if (searchTimeout) {
				clearTimeout(searchTimeout);
			}

			if (trimmedQuery.length >= 2) {
				performSearch(trimmedQuery);
			}
		}

		function performSearch(query) {
			if (isSearching) {
				return; // Prevent concurrent searches
			}

			isSearching = true;
			lastSearchQuery = query;
			
			// Show loading state
			showSearchLoading(true);
			
			// Use HTMX to perform the search
			htmx.ajax('POST', '/search-books', {
				values: { query: query },
				target: '#search-results',
				swap: 'innerHTML'
			}).then(() => {
				isSearching = false;
				showSearchLoading(false);
			}).catch((error) => {
				console.error('Search error:', error);
				isSearching = false;
				showSearchLoading(false);
				showSearchError('Search failed. Please try again.');
			});
		}

		function clearSearch() {
			const searchInput = document.getElementById('searchQuery');
			if (searchInput) {
				searchInput.value = '';
				clearSearchResults();
				lastSearchQuery = '';
			}
		}

		function clearSearchResults() {
			const searchResults = document.getElementById('search-results');
			if (searchResults) {
				searchResults.innerHTML = '<div class="no-results">Enter a search term above to find books on Royal Road.</div>';
			}
		}

		function showSearchLoading(show) {
			const indicator = document.getElementById('search-indicator');
			if (indicator) {
				indicator.style.opacity = show ? '1' : '0';
			}
		}

		function showSearchError(message) {
			const searchResults = document.getElementById('search-results');
			if (searchResults) {
				searchResults.innerHTML = `<div class="status-message status-error">${message}</div>`;
			}
		}

		function clearSearchStatus() {
			const statusDivs = ['search-status', 'memorize-status'];
			statusDivs.forEach(id => {
				const div = document.getElementById(id);
				if (div) {
					div.innerHTML = '';
				}
			});
		}

		// Memorized books management
		function loadMemorizedBooks() {
			setTimeout(() => {
				htmx.ajax('GET', '/memorized-books', {
					target: '#memorized-results',
					swap: 'innerHTML'
				}).catch((error) => {
					console.error('Failed to load memorized books:', error);
					showMemorizedBooksError('Failed to load memorized books.');
				});
			}, 100);
		}

		function showMemorizedBooksError(message) {
			const memorizedResults = document.getElementById('memorized-results');
			if (memorizedResults) {
				memorizedResults.innerHTML = `<div class="status-message status-error">${message}</div>`;
			}
		}

		// Enhanced HTMX event handlers
		function initializeHTMXEventHandlers() {
			// Before request - show loading states
			document.body.addEventListener('htmx:beforeRequest', function(event) {
				const target = event.target;
				
				// Add loading class for visual feedback
				if (target.classList.contains('memorize-btn') || target.classList.contains('remove-btn')) {
					target.disabled = true;
					target.style.opacity = '0.6';
				}
			});

			// After request - handle responses and cleanup
			document.body.addEventListener('htmx:afterRequest', function(event) {
				const xhr = event.detail.xhr;
				const target = event.target;
				
				// Re-enable buttons
				if (target.classList.contains('memorize-btn') || target.classList.contains('remove-btn')) {
					target.disabled = false;
					target.style.opacity = '1';
				}

				// Handle different types of requests
				if (xhr.responseURL.includes('/memorize-book')) {
					handleMemorizeResponse(xhr);
				} else if (xhr.responseURL.includes('/remove-memorized-book')) {
					handleRemoveResponse(xhr);
				} else if (xhr.responseURL.includes('/search-books')) {
					handleSearchResponse(xhr);
				}
			});

			// Handle HTMX errors
			document.body.addEventListener('htmx:responseError', function(event) {
				const xhr = event.detail.xhr;
				console.error('HTMX Error:', xhr.status, xhr.statusText);
				
				if (xhr.responseURL.includes('/search-books')) {
					showSearchError('Search failed. Please check your connection and try again.');
				} else if (xhr.responseURL.includes('/memorize-book')) {
					showStatusMessage('memorize-status', 'Failed to memorize book. Please try again.', 'error');
				} else if (xhr.responseURL.includes('/remove-memorized-book')) {
					showStatusMessage('memorized-results', 'Failed to remove book. Please try again.', 'error');
				}
			});

			// Handle network errors
			document.body.addEventListener('htmx:sendError', function(event) {
				console.error('HTMX Network Error:', event.detail);
				showStatusMessage('memorize-status', 'Network error. Please check your connection.', 'error');
			});
		}

		function handleMemorizeResponse(xhr) {
			const status = xhr.status;
			let statusDiv = document.getElementById('memorize-status');
			
			// Try both possible status divs (popular tab and search tab)
			if (!statusDiv) {
				statusDiv = document.getElementById('search-status');
			}
			
			if (status === 200) {
				showStatusMessage(statusDiv?.id || 'memorize-status', '‚úÖ Book memorized successfully!', 'success');
				
				// Refresh memorized books list if on search tab
				if (document.getElementById('search-tab').classList.contains('active')) {
					loadMemorizedBooks();
				}
			} else {
				const errorMsg = xhr.responseText || 'Failed to memorize book. Try again.';
				showStatusMessage(statusDiv?.id || 'memorize-status', `‚ùå ${errorMsg}`, 'error');
			}
		}

		function handleRemoveResponse(xhr) {
			if (xhr.status === 200) {
				// Success is handled by replacing the memorized books list
				showStatusMessage('memorize-status', '‚úÖ Book removed successfully!', 'success');
			} else {
				const errorMsg = xhr.responseText || 'Failed to remove book.';
				showStatusMessage('memorize-status', `‚ùå ${errorMsg}`, 'error');
			}
		}

		function handleSearchResponse(xhr) {
			if (xhr.status !== 200) {
				const errorMsg = xhr.responseText || 'Search failed.';
				showSearchError(`Search failed: ${errorMsg}`);
			}
		}

		function showStatusMessage(elementId, message, type) {
			const element = document.getElementById(elementId);
			if (element) {
				const cssClass = type === 'success' ? 'status-success' : 'status-error';
				element.innerHTML = `<div class="status-message ${cssClass}">${message}</div>`;
				
				// Clear status after 3 seconds
				setTimeout(() => {
					element.innerHTML = '';
				}, 3000);
			}
		}

		// Utility functions for better UX
		function addKeyboardShortcuts() {
			document.addEventListener('keydown', function(e) {
				// Ctrl/Cmd + K to focus search
				if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
					e.preventDefault();
					const searchInput = document.getElementById('searchQuery');
					if (searchInput && document.getElementById('search-tab').classList.contains('active')) {
						searchInput.focus();
					}
				}
				
				// Tab navigation
				if (e.key === '1' && e.altKey) {
					e.preventDefault();
					document.querySelector('[data-tab="popular"]').click();
				}
				if (e.key === '2' && e.altKey) {
					e.preventDefault();
					document.querySelector('[data-tab="search"]').click();
				}
			});
		}

		// Initialize keyboard shortcuts
		document.addEventListener('DOMContentLoaded', function() {
			addKeyboardShortcuts();
		});
	</script>
</body>
</html>